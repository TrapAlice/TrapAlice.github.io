<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
</head>

<style>
input{
    width: 40px;
    height: 40px;
}
</style>
<input id='run' type='button' style='height: 35px; width: 171px; margin-left: 3px;' value='Run'></input>
<p>Score: <span id='score'>0</span>  <span id='direction'></span></p>
<table>
    <tr>
        <td><input id='t-0-0' class='tile' type='button'></td>
        <td><input id='t-0-1' class='tile' type='button'></td>
        <td><input id='t-0-2' class='tile' type='button'></td>
        <td><input id='t-0-3' class='tile' type='button'></td>
    </tr>
    <tr>
        <td><input id='t-1-0' class='tile' type='button'></td>
        <td><input id='t-1-1' class='tile' type='button'></td>
        <td><input id='t-1-2' class='tile' type='button'></td>
        <td><input id='t-1-3' class='tile' type='button'></td>
    </tr>
    <tr>
        <td><input id='t-2-0' class='tile' type='button'></td>
        <td><input id='t-2-1' class='tile' type='button'></td>
        <td><input id='t-2-2' class='tile' type='button'></td>
        <td><input id='t-2-3' class='tile' type='button'></td>
    </tr>
    <tr>
        <td><input id='t-3-0' class='tile' type='button'></td>
        <td><input id='t-3-1' class='tile' type='button'></td>
        <td><input id='t-3-2' class='tile' type='button'></td>
        <td><input id='t-3-3' class='tile' type='button'></td>
    </tr>
</table>

<script>
    var running = false;
    var state = {
        score: 0,
        tiles: [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],
        ended: false,
        direction: -1,
    }

    $(".tile").click(function(){
        if ($(this).val() != 0) return;
        $(this).val(2);
        pos = $(this).attr("id").split("-");
        state.tiles[pos[1]][pos[2]] = $(this).val();
        if (running) run(state);
    });

    $("#run").click(function(){
        running = true;
        run(state);
    });

    var directions = ['UP', 'DOWN', 'LEFT', 'RIGHT'];


    function move_up(state){
        tiles = structuredClone(state.tiles);
        score = state.score;
        for (y=0; y<4; y++){
            for (x=0; x<4; x++){
                if (tiles[y][x] != 0){
                    for (i=y-1; i>=0; i--){
                        if (tiles[i][x] == 0){
                            tiles[i][x] = tiles[y][x];
                            tiles[y][x] = 0;
                            y = i;
                        }
                        else if (tiles[i][x] == tiles[y][x]){
                            tiles[i][x] *= 2;
                            tiles[y][x] = 0;
                            y = i;
                            score += tiles[y][x];
                            break;
                        }
                        else {
                            break;
                        }
                    }
                }
            }
        }
        return {score: score, tiles: tiles, ended: state.ended, direction: state.direction};
    }

    function move_down(state){
        tiles = structuredClone(state.tiles);
        score = state.score;
        for (y=3; y>=0; y--){
            for (x=0; x<4; x++){
                if (tiles[y][x] != 0){
                    for (i=y+1; i<4; i++){
                        if (tiles[i][x] == 0){
                            tiles[i][x] = tiles[y][x];
                            tiles[y][x] = 0;
                            y = i;
                        }
                        else if (tiles[i][x] == tiles[y][x]){
                            tiles[i][x] *= 2;
                            tiles[y][x] = 0;
                            y = i;
                            score += tiles[y][x];
                            break;
                        }
                        else {
                            break;
                        }
                    }
                }
            }
        }
        return {score: score, tiles: tiles, ended: state.ended, direction: state.direction};
    }

    function move_left(state){
        tiles = structuredClone(state.tiles);
        score = state.score;
        for (y=0; y<4; y++){
            for (x=0; x<4; x++){
                if (tiles[y][x] != 0){
                    for (i=x-1; i>=0; i--){
                        if (tiles[y][i] == 0){
                            tiles[y][i] = tiles[y][x];
                            tiles[y][x] = 0;
                            x = i;
                        }
                        else if (tiles[y][i] == tiles[y][x]){
                            tiles[y][i] *= 2;
                            tiles[y][x] = 0;
                            x = i;
                            score += tiles[y][x];
                            break;
                        }
                        else {
                            break;
                        }
                    }
                }
            }
        }
        return {score: score, tiles: tiles, ended: state.ended, direction: state.direction};
    }

    function move_right(state){
        tiles = structuredClone(state.tiles);
        score = state.score;
        for (y=0; y<4; y++){
            for (x=3; x>=0; x--){
                if (tiles[y][x] != 0){
                    for (i=x+1; i<4; i++){
                        if (tiles[y][i] == 0){
                            tiles[y][i] = tiles[y][x];
                            tiles[y][x] = 0;
                            x = i;
                        }
                        else if (tiles[y][i] == tiles[y][x]){
                            tiles[y][i] *= 2;
                            tiles[y][x] = 0;
                            x = i;
                            score += tiles[y][x];
                            break;
                        }
                        else {
                            break;
                        }
                    }
                }
            }
        }
        return {score: score, tiles: tiles, ended: state.ended, direction: state.direction};
    }

    function rand(max){
        return Math.floor(Math.random() * max);
    }

    function place_random_two(state){
        tiles = state.tiles;
        empty_tile_count = 0;
        empty_tiles = [];
        for (y=0;y<4;y++){
            for (x=0;x<4;x++){
                if (tiles[y][x] == 0){
                    empty_tiles.push([y,x]);
                    empty_tile_count++;
                }
            }
        }
        if (empty_tile_count == 0){
            return {score: state.score, tiles: state.tiles, ended: true, direction: state.direction};
        }
        pos = rand(empty_tile_count);
        tiles[empty_tiles[pos][0]][empty_tiles[pos][1]] = 2;
        return {score: state.score, tiles: tiles, ended: state.ended, direction: state.direction};
    }

    function load_game_state(new_state){
        state = new_state;
        for (x=0; x<4; x++){
            for (y=0; y<4; y++){
                value = state.tiles[x][y];
                if (value == 0) value = '';
                $("#t-" + x + "-" + y).val(value);
            }
        }
        $("#score").text(state.score);
    }


    function run(state){
        var game_count = 10;
        var turn_count = 100;

        states = [];
        for (i = 0; i < game_count; i++){
            states.push(structuredClone(state));
        }

        ended_games = 0;
        for (var i = 0; i < turn_count; i++){
            for (var j = 0; j < game_count; j++){
                if (states[j].ended == true) {
                    ended_games++;
                    continue;
                }
                direction = rand(4);
                new_state = null;
                switch(direction){
                    case 0:
                        new_state = move_up(states[j]);
                        break;
                    case 1:
                        new_state = move_down(states[j]);
                        break;
                    case 2:
                        new_state = move_left(states[j]);
                        break;
                    case 3:
                        new_state = move_right(states[j]);
                        break;
                }
                if (JSON.stringify(new_state.tiles) == JSON.stringify(states[j].tiles)){
                    continue;
                }
                states[j] = new_state;
                if (states[j].direction == -1){
                    states[j].direction = direction;
                }
                states[j] = place_random_two(states[j]);
            }
            if (ended_games == game_count-1){
                break;
            }
        }

        max_score = -1;
        max_score_state = null;
        for (i = 0; i < game_count; i++){
            if (states[i].score > max_score){
                max_score = states[i].score;
                max_score_state = states[i];
            }
        }
        $("#direction").text(directions[max_score_state.direction]);
        switch(max_score_state.direction){
            case 0:
                load_game_state(move_up(state));
                break;
            case 1:
                load_game_state(move_down(state));
                break;
            case 2:
                load_game_state(move_left(state));
                break;
            case 3:
                load_game_state(move_right(state));
                break;
        }
    }

    function tick(){
        run(state);
        load_game_state(place_random_two(state));
    }

    function auto_play(){
        tick();
        if (state.ended == true) return;
        setTimeout(()=>{auto_play();}, 100);
    }
</script>
